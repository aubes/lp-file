<?php

declare(strict_types=1);

namespace Aubes\LPFile\Tests;

use Aubes\LPFile\LPFile;
use Aubes\LPFile\Policy\PolicyInterface;
use PHPUnit\Framework\TestCase;
use Prophecy\Argument;
use Prophecy\PhpUnit\ProphecyTrait;

class FopenTest extends TestCase
{
    use ProphecyTrait;

    public function testInvokeDefault()
    {
        $policy = $this->prophesize(PolicyInterface::class);
        $policy->getProtocole()->willReturn('file');
        $policy->getSupportedMode()->willReturn(PolicyInterface::MODE_READ);
        $policy->validate(Argument::any(), Argument::any(), Argument::any())->willReturnArgument(0);

        $LPFile = new LPFile();
        $LPFile->addPolicy($policy->reveal());

        $this->assertIsResource($LPFile->fopen(__DIR__ . '/Files.txt/test.txt', 'r'));
    }

    public function testInvokeWithoutPolicy()
    {
        $LPFile = new LPFile();

        $this->expectException(\RuntimeException::class);
        $this->expectExceptionMessage('Protocole is not allowed');

        $LPFile->fopen(__DIR__ . '/Files.txt/test.txt', 'r');
    }

    public function testInvokeUnknownProtocole()
    {
        $policy = $this->prophesize(PolicyInterface::class);
        $policy->getProtocole()->willReturn('file');
        $policy->getSupportedMode()->willReturn(PolicyInterface::MODE_READ);

        $LPFile = new LPFile();
        $LPFile->addPolicy($policy->reveal());

        $this->expectException(\RuntimeException::class);
        $this->expectExceptionMessage('Protocole is not allowed');

        $LPFile->fopen('unknown://', 'r');
    }

    /**
     * @dataProvider dateProviderInvokeWrongMode
     */
    public function testInvokeWrongMode($policyMode, $fopenMode)
    {
        $policy = $this->prophesize(PolicyInterface::class);
        $policy->getProtocole()->willReturn('file');
        $policy->getSupportedMode()->willReturn($policyMode);
        $policy->validate(Argument::any(), Argument::any(), Argument::any())->willReturnArgument(0);

        $LPFile = new LPFile();
        $LPFile->addPolicy($policy->reveal(), $policyMode);

        $this->expectException(\RuntimeException::class);
        $this->expectExceptionMessage('No policy validated');

        $LPFile->fopen(__DIR__ . '/Files.txt/test-mode.txt', $fopenMode);

        $this->assertContains('Invalid mode', $LPFile->getLastViolations());
    }

    public function dateProviderInvokeWrongMode()
    {
        return [
            [PolicyInterface::MODE_READ, 'w'],
            [PolicyInterface::MODE_READ, 'a'],
            [PolicyInterface::MODE_READ, 'x'],
            [PolicyInterface::MODE_READ, 'c'],
            [PolicyInterface::MODE_WRITE, 'r'],
            [PolicyInterface::MODE_READ, 'w+'],
            [PolicyInterface::MODE_READ, 'a+'],
            [PolicyInterface::MODE_READ, 'x+'],
            [PolicyInterface::MODE_READ, 'c+'],
            [PolicyInterface::MODE_WRITE, 'r+'],
        ];
    }
}
